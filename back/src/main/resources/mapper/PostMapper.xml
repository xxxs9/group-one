<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.heeexy.example.dao.PostDao">

    <resultMap id="postMap" type="com.heeexy.example.util.model.One2Many">
        <id column="postId" property="postId"/>
        <result column="postType" property="postType" />
        <result column="postTypeId" property="postTypeId" />
        <result column="postOwnerName" property="postOwnerName" />
        <result column="postText" property="postText" />
        <result column="postTime" property="postTime" />
        <result column="likeCount" property="likeCount"/>
        <result column="likeOffset" property="likeOffset"/>
        <result column="browseCount" property="browseCount"/>
        <result column="browseOffset" property="browseOffset"/>
        <result column="postState" property="postState" />
        <collection property="postTagList" ofType="String">
            <id column="postTagName" property="postTagName"/>
        </collection>
    </resultMap>

    <select id="countUser" resultType="java.lang.Integer">
        SELECT count(0)
        FROM post_table p
        WHERE p.post_state = '0'
    </select>

    <select id="listPost" resultMap="postMap">
        SELECT
          p.*,
          (SELECT count(0) FROM `like` WHERE `like`.post_id = p.postId)                          likeCount,
          (SELECT count(0) FROM browse_records br WHERE br.post_id = p.postId)                   browseCount,
          (SELECT username FROM `user` u WHERE u.uuid = p.postOwnerId)                           postOwnerName,
          (SELECT tag_name FROM tag t WHERE t.tag_no = pt2.tag_id)                               postTagName,
          (SELECT categories_name FROM post_categories pc WHERE pc.categories_id = p.postTypeId) postType
          FROM(
            SELECT
              post_id                               postId,
              post_type_id                          postTypeId,
              post_owner_id                         postOwnerId,
              post_text                             postText,
              DATE_FORMAT(post_time, '%Y.%m.%d %T') postTime,
              like_offset                           likeOffset,
              browse_offset                         browseOffset,
              post_state                            postState
            FROM post_table
            WHERE post_state = '0'
            ORDER BY post_id
            LIMIT #{offSet}, #{pageRow}
          ) p
          LEFT JOIN post_tag pt2 ON pt2.post_id = p.postId
          ORDER BY p.postId
    </select>

</mapper>