<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.heeexy.example.dao.CollectionDao">
    <resultMap id="collectionMap" type="com.heeexy.example.util.model.One2Many">
        <id column="collectionId" property="collectionId" />
        <result column="userId" property="userId" />
        <result column="postId" property="postId" />
        <result column="collectionTime" property="collectionTime" />
        <result column="collectionState" property="collectionState" />
        <result column="collectionCount" property="collectionCount" />
    </resultMap>

    <select id="getByUserId" parameterType="java.lang.Integer" resultMap="collectionMap">
        SELECT
        collection_id                                                            collectionId
        ,DATE_FORMAT(collection_time, '%Y.%m.%d %T')                             collectionTime
        ,post_id                                                                 postId
        ,(SELECT post_text FROM post_table WHERE post_table.post_id = c.post_id) postText
        FROM collection c
        WHERE user_id = #{userId}
        ORDER BY collection_time DESC LIMIT #{offSet}, #{pageRow}
    </select>

    <select id="countByUserId" resultType="java.lang.Integer">
        SELECT COUNT (collection_id) FROM collection WHERE user_id = #{userId}
    </select>

    <insert id="addCollection" useGeneratedKeys="true" keyProperty="collectionId">
        INSERT INTO collection(user_id,post_id,collection_state)
        VALUES (#{userId},#{postId},#{collectionState},#{collectionCount})
    </insert>

    <update id="removeCollection">
        UPDATE collection SET collection_state = #{collectionState},collection_count = #{collectionCount}
        WHERE collection_id = #{collectionId}
    </update>

    <select id="getByPostId" resultType="java.lang.Integer">
        SELECT COUNT(0) FROM collection WHERE post_id = #{postId} AND collection_state = 1
    </select>

    <select id="getByCollectionCount" resultType="java.lang.Integer">
        SELECT collection_count FROM collection WHERE user_id = #{userId}
    </select>
</mapper>